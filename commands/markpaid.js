const { SlashCommandBuilder } = require('discord.js');
const fs = require('fs');
const path = require('path');

module.exports = {
  data: new SlashCommandBuilder()
    .setName('markpaid')
    .setDescription('Mark an order as paid and notify the buyer')
    .addStringOption(opt =>
      opt.setName('order')
        .setDescription('Order ID (e.g. 1027)')
        .setRequired(true))
    .addStringOption(opt =>
      opt.setName('item')
        .setDescription('Item purchased (e.g. Raccoon, Sheckles)')
        .setRequired(true))
    .addUserOption(opt =>
      opt.setName('user')
        .setDescription('Buyer\'s Discord user')
        .setRequired(true)),

  async execute(interaction) {
    const orderId = interaction.options.getString('order');
    const itemName = interaction.options.getString('item');
    const user = interaction.options.getUser('user');

    // Save to orders.json
    const ordersPath = path.join(__dirname, '..', 'orders.json');
    let orders = {};

    if (fs.existsSync(ordersPath)) {
      orders = JSON.parse(fs.readFileSync(ordersPath, 'utf8'));
    }

    orders[orderId] = itemName;
    fs.writeFileSync(ordersPath, JSON.stringify(orders, null, 2));

    // Edit log message if exists
    const logChannelId = '1397212138753495062';
    const client = interaction.client;

    try {
      const channel = await client.channels.fetch(logChannelId);
      if (channel && channel.isTextBased()) {
        const messages = await channel.messages.fetch({ limit: 50 });
        const logMessage = messages.find(msg =>
          msg.embeds?.[0]?.title === 'ğŸ“¥ New Bloom Haven Order' &&
          msg.embeds[0].fields?.some(f => f.name === 'ğŸ§¾ Order ID' && f.value === orderId)
        );

        if (logMessage) {
          const embed = logMessage.embeds[0];
          const updatedFields = embed.fields.map(field => {
            if (field.name === 'ğŸ’³ Payment') {
              return { ...field, value: 'âœ… Payment Confirmed' };
            }
            return field;
          });

          await logMessage.edit({ embeds: [{ ...embed.toJSON(), fields: updatedFields }] });
        }
      }
    } catch (e) {
      console.warn('âš ï¸ Could not edit log message:', e);
    }

    try {
      await user.send(
        `ğŸ’µ **Payment Confirmed Automatically**\n\n` +
        `ğŸ§¾ Order \`${orderId}\` for **${itemName}** has been marked as paid.\n` +
        `ğŸ“¦ Your item is now queued for in-game delivery.\n` +
        `â³ Youâ€™ll receive the private server link shortly.\n\n` +
        `ğŸ’¬ This message was generated by **Bloom Haven AutoOrder v2.1**`
      );

      await interaction.reply({
        content: `âœ… Order \`${orderId}\` marked as paid and saved as **${itemName}**.`,
        ephemeral: true
      });
    } catch (err) {
      console.error('âŒ DM failed:', err);
      await interaction.reply({
        content: `âŒ Couldn't DM the user.`,
        ephemeral: true
      });
    }
  }
};
